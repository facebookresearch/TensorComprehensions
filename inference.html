

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Range Inference &mdash; Tensor Comprehensions v0.1.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/css/tc_theme.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Tensor Comprehensions v0.1.0 documentation" href="index.html"/>
        <link rel="next" title="Relation to Halide" href="halide_integration.html"/>
        <link rel="prev" title="Semantics" href="semantics.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html">
          

          
            
            <img src="_static/tc-logo-full-color-with-text-2.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                v0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Index</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">What is Tensor Comprehensions?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#tensor-comprehension-notation">Tensor Comprehension Notation</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#examples-of-tc">Examples of TC</a><ul>
<li class="toctree-l3"><a class="reference internal" href="introduction.html#simple-matrix-vector">Simple matrix-vector</a></li>
<li class="toctree-l3"><a class="reference internal" href="introduction.html#simple-matrix-multiply">Simple matrix-multiply</a></li>
<li class="toctree-l3"><a class="reference internal" href="introduction.html#simple-2-d-convolution-no-stride-no-padding">Simple 2-D convolution (no stride, no padding)</a></li>
<li class="toctree-l3"><a class="reference internal" href="introduction.html#simple-2d-max-pooling">Simple 2D max pooling</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="aten_integration.html">Examples of TC integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="semantics.html">Semantics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="semantics.html#types">Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="semantics.html#data-layout">Data Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="semantics.html#variable-scoping">Variable Scoping</a></li>
<li class="toctree-l2"><a class="reference internal" href="semantics.html#implied-reductions">Implied Reductions</a></li>
<li class="toctree-l2"><a class="reference internal" href="semantics.html#size-expressions">Size Expressions</a></li>
<li class="toctree-l2"><a class="reference internal" href="semantics.html#statements">Statements</a></li>
<li class="toctree-l2"><a class="reference internal" href="semantics.html#expressions">Expressions</a></li>
<li class="toctree-l2"><a class="reference internal" href="semantics.html#grammar">Grammar</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Range Inference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#the-range-inference-algorithm">The Range Inference Algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="#preconditions">Preconditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#worked-examples">Worked Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#inverted-indexing">Inverted indexing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#strided-indexing-with-constant-stride">Strided indexing with constant stride</a></li>
<li class="toctree-l3"><a class="reference internal" href="#strided-indexing-with-offsets">Strided indexing with offsets</a></li>
<li class="toctree-l3"><a class="reference internal" href="#strided-indexing-with-dynamic-stride">Strided indexing with dynamic stride</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="halide_integration.html">Relation to Halide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="halide_integration.html#use-of-halide-in-tc">Use of Halide in TC</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="mapping_options.html">Mapping Options</a><ul>
<li class="toctree-l2"><a class="reference internal" href="mapping_options.html#how-to-choose-starting-mapping-options">How to choose starting mapping options?</a></li>
<li class="toctree-l2"><a class="reference internal" href="mapping_options.html#options-api">Options API</a></li>
<li class="toctree-l2"><a class="reference internal" href="mapping_options.html#defaults-provided">Defaults provided</a></li>
<li class="toctree-l2"><a class="reference internal" href="mapping_options.html#available-options">Available options</a></li>
<li class="toctree-l2"><a class="reference internal" href="mapping_options.html#impact-on-performance">Impact on Performance</a></li>
<li class="toctree-l2"><a class="reference internal" href="mapping_options.html#possible-compiler-issues">Possible compiler issues</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="autotuner.html">Autotuner</a><ul>
<li class="toctree-l2"><a class="reference internal" href="autotuner.html#parameters-for-autotuning">Parameters for Autotuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="autotuner.html#caching">Caching</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="performance.html">Performance of TC</a></li>
</ul>
<p class="caption"><span class="caption-text">Machine Learning with TC</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="ml_with_tc.html">Positioning of TC in ML Software stacks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="ml_with_tc.html#integrating-any-ml-framework">Integrating any ML framework</a><ul>
<li class="toctree-l3"><a class="reference internal" href="ml_with_tc.html#one-tc-function-one-kernel">One TC function one kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="ml_with_tc.html#no-variable-allocations">No Variable Allocations</a></li>
<li class="toctree-l3"><a class="reference internal" href="ml_with_tc.html#graph-level">Graph Level</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="ml_with_tc.html#minimal-information-to-write-ml-layers-concisely">Minimal information to write ML layers concisely</a><ul>
<li class="toctree-l3"><a class="reference internal" href="ml_with_tc.html#c-style-loops">C-style loops</a></li>
<li class="toctree-l3"><a class="reference internal" href="ml_with_tc.html#halide">Halide</a></li>
<li class="toctree-l3"><a class="reference internal" href="ml_with_tc.html#tc">TC</a></li>
<li class="toctree-l3"><a class="reference internal" href="ml_with_tc.html#matrix-languages">Matrix Languages</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker_image.html">Installing TC from docker image</a><ul>
<li class="toctree-l2"><a class="reference internal" href="docker_image.html#tc-runtime-image-with-nvidia-docker">TC runtime image with nvidia-docker</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="installation_conda_dep.html">Building with conda packaged dependencies in Conda Environment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation_conda_dep.html#step-1-install-system-dependencies">Step 1: Install system dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation_conda_dep.html#step-2-setup-gcc-g">Step 2: Setup gcc / g++</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation_conda_dep.html#step-3-get-protobuf3-4">Step 3: Get Protobuf3.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation_conda_dep.html#step-4-install-anaconda3">Step 4: Install Anaconda3</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation_conda_dep.html#step-5-get-cuda-and-cudnn">Step 5: Get CUDA and CUDNN</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation_conda_dep.html#step-6-install-tc">Step 6: Install TC</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation_conda_dep.html#step-7-verify-tc-installation">Step 7: Verify TC installation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="installation_conda.html">Building from Source in Conda Environment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation_conda.html#step-1-install-some-build-dependencies">Step 1: Install some build dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation_conda.html#step-2-setup-gcc-g">Step 2: Setup gcc / g++</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation_conda.html#step-3-install-clang-llvm">Step 3: Install Clang+LLVM</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation_conda.html#step-4-install-anaconda3">Step 4: Install Anaconda3</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation_conda.html#step-5-get-cuda-and-cudnn">Step 5: Get CUDA and CUDNN</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation_conda.html#step-6-get-protobuf3-4">Step 6: Get Protobuf3.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation_conda.html#step-7-installing-tc">Step 7: Installing TC</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation_conda.html#step-8-verify-tc-installation">Step 8: Verify TC installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation_conda.html#build-with-basic-caffe2-integration">Build with Basic Caffe2 Integration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="installation_non_conda.html">Building from Source in Non-Conda Environment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation_non_conda.html#step-1-install-some-build-dependencies">Step 1: Install some build dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation_non_conda.html#step-2-setup-gcc-g">Step 2: Setup gcc / g++</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation_non_conda.html#step-3-install-clang-llvm">Step 3: Install Clang+LLVM</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation_non_conda.html#step-4-get-cuda-and-cudnn">Step 4: Get CUDA and CUDNN</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation_non_conda.html#step-5-get-protobuf3-4">Step 5: Get Protobuf3.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation_non_conda.html#step-6-python-install">Step 6: Python install</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation_non_conda.html#step-7-install-tc">Step 7: Install TC</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation_non_conda.html#step-8-verify-tc-installation">Step 8: Verify TC installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation_non_conda.html#build-with-basic-caffe2-integration">Build with Basic Caffe2 Integration</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Tensor Comprehensions</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Range Inference</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/inference.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="range-inference">
<span id="inference"></span><h1>Range Inference<a class="headerlink" href="#range-inference" title="Permalink to this headline">¶</a></h1>
<p>In Tensor Comprehensions, loops are implicit and output tensors sizes
are inferred. Concretely, when a user write something like the
following stencil:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">C</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Tensor Comprehensions must deduce the range of values that <code class="code docutils literal"><span class="pre">i</span></code> iterates
over, and from this we derive the size of the tensor <code class="code docutils literal"><span class="pre">A</span></code>. We also must
infer the size of loops that reduce, for example, the implicit loop
over <code class="code docutils literal"><span class="pre">k</span></code> in a matrix multiply:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span>def matmul(float(I, K) B, float(K, J) C) -&gt; A {
  A(i, j) +=! B(i, k) * C(k, j)
}
</pre></div>
</div>
<p>If this range inference procedure fails to match the user&#8217;s intent,
then in the first case the output will not be the size they expect,
and in the second case the output <em>values</em> will be incorrect, as
either too few or too many terms were included in the summation.</p>
<p>To program productively, one must be able to mentally emulate the
written code on the abstract machine defined by the language
semantics. Regardless of how well-defined it is, if your source code
doesn&#8217;t do what you think it does, you have a bug. Thus it&#8217;s critical
that users build a mental model of how we infer ranges, and are able
to do range inference in their heads as they write code. If this
requires more thought than writing explicit loops would, we have
failed.</p>
<p>With this in mind, we eschew heavy-duty mathematical tools, and take a
more straightforward approach for the sake of usability. We infer
ranges only in cases where we feel they are obvious, and require
explicit annotation elsewhere. We intend to fine-tune this boundary in
the future depending on what users find surprising.</p>
<div class="section" id="the-range-inference-algorithm">
<h2>The Range Inference Algorithm<a class="headerlink" href="#the-range-inference-algorithm" title="Permalink to this headline">¶</a></h2>
<p>To a good first approximation, we infer rectangular ranges that are as
large as possible without reading out of bounds on the inputs. If
there is more than one way to do this, we throw an error and require
explicit annotation using a <code class="code docutils literal"><span class="pre">where</span></code> clause.</p>
<p>This rule is sufficient to understand the matrix multiply case
above. Maximizing the range of <code class="code docutils literal"><span class="pre">i</span></code> gives it the range of the number of
rows of B. Similarly maximizing the range of <code class="code docutils literal"><span class="pre">j</span></code> gives it the range of
the columns of C. <code class="code docutils literal"><span class="pre">k</span></code> is used twice, so making <code class="code docutils literal"><span class="pre">k</span></code> as large as
possible gives it the lesser of the number of columns of B and the
number of rows of C. These in turn are constrained to be equal by the
type signature of the function (they are both <code class="code docutils literal"><span class="pre">K</span></code>).</p>
<p>Now consider a stencil:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+=</span> <span class="n">B</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
<p>There are multiple ways in which we could maximize the ranges of <code class="code docutils literal"><span class="pre">i</span></code>
and <code class="code docutils literal"><span class="pre">k</span></code>. If we first maximize <code class="code docutils literal"><span class="pre">i</span></code>, we might say that it ranges over
the entirety of B. This forces <code class="code docutils literal"><span class="pre">k</span></code> to take on a single value only,
which will not result in the output one expects from a convolution (it
ignores most of the kernel!). If we first maximize <code class="code docutils literal"><span class="pre">k</span></code>, so that it
ranges over the entirety of <code class="code docutils literal"><span class="pre">K</span></code>, then in order to not read out of bounds
the range of <code class="code docutils literal"><span class="pre">i</span></code> must be smaller, and we get an output that is
slightly smaller than the input. This is the behavior we prefer.</p>
<p>In order to make this unambiguous without requiring explicit
annotation in this simple case, range inference proceeds in rounds. We
maintain a set of unresolved variables. Initially it contains all
variables not constrained with an explicit <code class="code docutils literal"><span class="pre">where</span></code> clause. In each
round, we consider all the tensor argument expressions that contain a
single unresolved variable, and construct a boolean expression that
states the access is not out-of-bounds. We then use tools from
Halide (<code class="code docutils literal"><span class="pre">solve_for_inner_interval</span></code>) to find the maximal range for
the variable that satisfies this condition, given the ranges of
variables already resolved in previous rounds. If the variable was
already constrained this round by some other tensor access, we take
the intersection of the inferred ranges.</p>
<p>For the stencil above, in the first round we ignore the expression
<code class="code docutils literal"><span class="pre">B(i</span> <span class="pre">+</span> <span class="pre">k)</span></code> because it contains multiple unresolved variables. We use
the expression <code class="code docutils literal"><span class="pre">K(k)</span></code> to deduce a range for <code class="code docutils literal"><span class="pre">k</span></code>. In the second
round, <code class="code docutils literal"><span class="pre">B(i</span> <span class="pre">+</span> <span class="pre">k)</span></code> now contains a single unresolved variable, and we
use the already-inferred range of <code class="code docutils literal"><span class="pre">k</span></code> to deduce a maximal range for
<code class="code docutils literal"><span class="pre">i</span></code>.</p>
</div>
<div class="section" id="preconditions">
<h2>Preconditions<a class="headerlink" href="#preconditions" title="Permalink to this headline">¶</a></h2>
<p>While this procedure produces easy-to-justify ranges for each
variable, it is not sufficient to ensure that no out-of-bounds reads
occur. For example consider:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">C</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">D</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
</pre></div>
</div>
<p>In the first round, we can resolve both <code class="code docutils literal"><span class="pre">i</span></code> and <code class="code docutils literal"><span class="pre">j</span></code>, using <code class="code docutils literal"><span class="pre">B(i)</span></code> and
<code class="code docutils literal"><span class="pre">D(j)</span></code> respectively. This guarantees that there are no out-of-bounds reads
on <code class="code docutils literal"><span class="pre">B</span></code> and <code class="code docutils literal"><span class="pre">D</span></code>, and defines the size of <code class="code docutils literal"><span class="pre">A</span></code>. The size of <code class="code docutils literal"><span class="pre">C</span></code> could be used to further
restrain the range of <code class="code docutils literal"><span class="pre">i</span></code> or <code class="code docutils literal"><span class="pre">j</span></code> to avoid out-of-bounds reads on <code class="code docutils literal"><span class="pre">C</span></code>. But there
is no second round since the ranges for all variables have been resolved; and
even if there would be, the expression <code class="code docutils literal"><span class="pre">i</span> <span class="pre">+</span> <span class="pre">j</span></code> would not translate into a
unique rectangular shape for <code class="code docutils literal"><span class="pre">i</span></code> and <code class="code docutils literal"><span class="pre">j</span></code>. So we are left with the requirement
that <code class="code docutils literal"><span class="pre">C</span></code> is large enough to cover all reads. In some cases we can statically
prove this condition (for example if the sizes of <code class="code docutils literal"><span class="pre">B</span></code>, <code class="code docutils literal"><span class="pre">C</span></code>, and <code class="code docutils literal"><span class="pre">D</span></code> are known
constants). In general we emit a compile-time warning.</p>
<p>We intend to add runtime checking of these conditions in the future. However, for some preconditions, it is never desirable to
check them at runtime. Consider a lookup table:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">lut</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">J</span><span class="p">)</span> <span class="n">B</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="n">C</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">A</span> <span class="p">{</span>
  <span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">C</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The range of <code class="code docutils literal"><span class="pre">i</span></code> is constrained by its use in <code class="code docutils literal"><span class="pre">C</span></code>, but we are left with
the additional precondition that the <em>values</em> in <code class="code docutils literal"><span class="pre">C</span></code> over that range
never exceed the size of <code class="code docutils literal"><span class="pre">B</span></code>. Checking this at runtime would require an
expensive bounds check in the inner loop. As with the previous case,
we currently just emit a compile-time notification that this unchecked
precondition exists. The user can suppress it and make this code
unconditionally safe by explicitly clamping the expression <code class="code docutils literal"><span class="pre">C(i)</span></code> to be
within the bounds of <code class="code docutils literal"><span class="pre">B</span></code> like so:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">lut</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">J</span><span class="p">)</span> <span class="n">B</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="n">C</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">A</span> <span class="p">{</span>
  <span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">C</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">J</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Though of course this also has a performance impact.</p>
</div>
<div class="section" id="worked-examples">
<h2>Worked Examples<a class="headerlink" href="#worked-examples" title="Permalink to this headline">¶</a></h2>
<p>We now describe how range inference reasons about several more complex
examples. If you find a confusing case, feel free to request that we
add it to this section.</p>
<div class="section" id="inverted-indexing">
<h3>Inverted indexing<a class="headerlink" href="#inverted-indexing" title="Permalink to this headline">¶</a></h3>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">reverted</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="n">B</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">A</span> <span class="p">{</span>
  <span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="mi">10</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>From the use in <code class="code docutils literal"><span class="pre">B</span></code>, range inference constructs the condition:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="mi">10</span> <span class="o">-</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">I</span>
</pre></div>
</div>
<p>This is rearranged by Halide&#8217;s solver to give the following range:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="mi">9</span> <span class="o">-</span> <span class="n">I</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">11</span>
</pre></div>
</div>
</div>
<div class="section" id="strided-indexing-with-constant-stride">
<h3>Strided indexing with constant stride<a class="headerlink" href="#strided-indexing-with-constant-stride" title="Permalink to this headline">¶</a></h3>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">subsample_2</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="n">B</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">A</span> <span class="p">{</span>
  <span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>From the use, range inference constructs the condition:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">I</span>
</pre></div>
</div>
<p>This is rearranged into:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">I</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</pre></div>
</div>
<p>Note that the division is integer division, which rounds towards
negative infinity in Tensor Comprehensions and Halide.</p>
</div>
<div class="section" id="strided-indexing-with-offsets">
<h3>Strided indexing with offsets<a class="headerlink" href="#strided-indexing-with-offsets" title="Permalink to this headline">¶</a></h3>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">average_pool_2</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="n">B</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">A</span> <span class="p">{</span>
  <span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">B</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>From the uses, range inference constructs the conditions:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">I</span>
<span class="mi">0</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">I</span>
</pre></div>
</div>
<p>These are rearranged into:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">I</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">I</span><span class="o">/</span><span class="mi">2</span>
</pre></div>
</div>
<p>The intersection of these two ranges is:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">I</span><span class="o">/</span><span class="mi">2</span>
</pre></div>
</div>
<p>One could write the equivalent code:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">average_pool_2</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="n">B</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">A</span> <span class="p">{</span>
  <span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="n">where</span> <span class="n">k</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The syntax <code class="code docutils literal"><span class="pre">where</span> <span class="pre">k</span> <span class="pre">in</span> <span class="pre">lb:ub</span></code> is inclusive of the lower bound
and exclusive of the upper bound: it constrains the range of <code class="code docutils literal"><span class="pre">k</span></code> to
the integers between <code class="code docutils literal"><span class="pre">lb</span></code> and <code class="code docutils literal"><span class="pre">ub-1</span></code>, here <code class="code docutils literal"><span class="pre">k</span></code> may only take the values
<code class="code docutils literal"><span class="pre">0</span></code> and <code class="code docutils literal"><span class="pre">1</span></code>.</p>
<p>Since the variable <code class="code docutils literal"><span class="pre">k</span></code> is already resolved by the where clause. From the
use of <code class="code docutils literal"><span class="pre">i</span></code>, range inference constructs the condition:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">I</span>
</pre></div>
</div>
<p>We eliminate k by taking the conjunction of the expression over all
values of k, using Halide&#8217;s <code class="docutils literal"><span class="pre">and_condition_over_domain</span></code>. For the
lower bound, <code class="code docutils literal"><span class="pre">k</span> <span class="pre">==</span> <span class="pre">0</span></code> dominates. For the upper bound, <code class="code docutils literal"><span class="pre">k</span> <span class="pre">==</span> <span class="pre">1</span></code>
dominates.</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">I</span>
</pre></div>
</div>
<p>This is equivalent to the intersection of the conditions in the
unrolled case, and so we get the same result:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">I</span><span class="o">/</span><span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="section" id="strided-indexing-with-dynamic-stride">
<h3>Strided indexing with dynamic stride<a class="headerlink" href="#strided-indexing-with-dynamic-stride" title="Permalink to this headline">¶</a></h3>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">subsample_2</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="n">B</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="n">S</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">A</span> <span class="p">{</span>
  <span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The value of <code class="code docutils literal"><span class="pre">S(0)</span></code> is not fixed until runtime, so we can&#8217;t resolve the
size of <code class="code docutils literal"><span class="pre">A</span></code> or the range of the loop. This case throws a compile-time
error. A <code class="code docutils literal"><span class="pre">where</span></code> clause that defines the range of <code class="code docutils literal"><span class="pre">i</span></code> is required.</p>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="halide_integration.html" class="btn btn-neutral float-right" title="Relation to Halide" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="semantics.html" class="btn btn-neutral" title="Semantics" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Tensor Comprehensions contributors and users.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'v0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>